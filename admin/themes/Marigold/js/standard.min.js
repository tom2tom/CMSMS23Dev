/*!
Marigold-theme support
(C) CMSMS <coreteam@cmsmadesimple.org>
License: GPL2+
*/
;(function(a,$){"use strict";$(document).ready(function(){b.view_init();b.helper_init()});var b={cookie_handler:"themes/Marigold/includes/js-cookie.min.js",small_width:992,view_init:function(){var f=this,c=$(".toggle-button"),e=$("#pg_container"),d=$("#pg_pagemenu");this.handleSidebar(e);c.on("click",function(g){g.preventDefault();if(e.hasClass("sidebar-on")){f._closeSidebar(e,d)}else{f._showSidebar(e,d)}});$(window).resize(function(){f.handleSidebar(e);f.updateDisplay()});this.toggleSubMenu(d,50);this.showNotifications();this.migrateUIElements();this.updateDisplay();this.setupAlerts()},helper_init:function(){$("a[rel=external]").attr("target","_blank");$("input.defaultfocus:eq(0), input[autofocus]").focus();if(!this._isLocalStorage()){this.loadScript(this.cookie_handler)}},loadScript:function(f,e,d){var c=true,h=null,g=true;if($.isFunction(e)){h=e;c=d||c}else{c=e||c;h=d||h}$('script[type="text/javascript"]').each(function(){var i=(f!==$(this).attr("src"));return i});if(g){$.ajax({type:"GET",url:f,async:false,success:h,dataType:"script",cache:c})}else{if($.isFunction(h)){h.call(this)}}},setStorageValue:function(f,g,c){try{if(this._isLocalStorage()){localStorage.removeItem(f);var h;if(c!==null){var d=new Date().getTime()+(c*24*60*60*1000);h={value:g,timestamp:d}}else{h={value:g,timestamp:""}}localStorage.setItem(f,JSON.stringify(h))}else{if(this._isCookieScript()){if(c!==null){Cookies.set(f,g,{expires:c})}else{Cookies.set(f,g)}}else{throw"No cookie storage!"}}}catch(e){console.log("localStorage Error: set("+f+", "+g+")");console.log(e)}},getStorageValue:function(c){var e;if(this._isLocalStorage()){var d=JSON.parse(localStorage.getItem(c));if(d!==null&&d.timestamp<new Date().getTime()){this.removeStorageValue(c)}else{if(d!==null){e=d.value}}}else{if(this._isCookieScript()){e=Cookies(c)}else{e=""}}return e},removeStorageValue:function(c){if(this._isLocalStorage()){localStorage.removeItem(c)}else{if(this._isCookieScript()){Cookies.remove(c)}}},equalHeight:function(d){var c=0;d.each(function(){var e=$(this).height();if(e>c){c=e}});d.height(c)},_isLocalStorage:function(){return typeof(Storage)!=="undefined"},_isCookieScript:function(){return typeof(Cookies)!=="undefined"},_isMobileDevice:function(){var d=navigator.userAgent.toLowerCase(),c=/(Android|iPhone|iPad|iPod|Blackberry|Dolphin|IEMobile|WPhone|Windows Mobile|IEMobile9||IEMobile10||IEMobile11|Kindle|Mobile|MMP|MIDP|Pocket|PSP|Symbian|Smartphone|Sreo|Up.Browser|Up.Link|Vodafone|WAP|Opera Mini|Opera Tablet|Mobile|Fennec)/i;if(d.match(c)&&(("ontouchstart" in window)||(navigator.msMaxTouchPoints>0)||window.DocumentTouch&&document instanceof DocumentTouch)){return true}},handleSidebar:function(d){var c=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;if(this.getStorageValue("sidebar-pref")==="sidebar-off"||c<=this.small_width){d.addClass("sidebar-off").removeClass("sidebar-on")}else{d.addClass("sidebar-on").removeClass("sidebar-off")}},toggleSubMenu:function(d,c){var e=this;d.find("li.current span").addClass("open-sub");d.find("> li > span").click(function(){var g=$(this).next(),f=[];if(g.is(":visible")===false){f.push(d.find("ul").slideUp(c))}f.push(g.slideToggle(c));$.when.apply($,f).done(function(){e.updateDisplay()})})},showNotifications:function(){if(typeof cms_data.toastinfos!=="undefined"){cms_notify("info",cms_data.toastinfos)}if(typeof cms_data.toastgoods!=="undefined"){cms_notify("success",cms_data.toastgoods)}if(typeof cms_data.toastwarns!=="undefined"){cms_notify("warn",cms_data.toastwarns)}if(typeof cms_data.toasterrs!=="undefined"){cms_notify("error",cms_data.toasterrs)}$(".pagewarning, .message, .pageerrorcontainer, .pagemcontainer").prepend('<span class="close-warning" title="'+cms_lang("gotit")+'"></span>');$(document).on("click",".close-warning",function(){$(this).parent().hide();$(this).parent().remove()});var d=this,c=$("body").attr("id")+"_notification";$(".pagewarning .close-warning").click(function(){d.setStorageValue(c,"hidden",60)});if(this.getStorageValue(c)==="hidden"){$(".pagewarning").addClass("hidden")}$(document).on("cms_ajax_apply",function(g){var f=(g.response==="Success")?"success":"error";cms_notify(f,g.details)})},migrateUIElements:function(){$('input[type="submit"], :button[data-ui-icon]').each(function(){var d=$(this);if(!(d.hasClass("noautobtn")||d.hasClass("no-ui-btn"))){var f,c,e;if(d.is("[name*=submit]")){f="iconcheck"}else{if(d.is("[name*=apply]")){f="iconapply"}else{if(d.is("[name*=cancel]")||d.is("[name*=close]")){f="iconclose"}else{if(d.is("[name*=reset]")||d.attr("id")==="refresh"){f="iconundo"}else{f=""}}}}if(d.is("input")){c=d.val()}else{c=d.text()}e=$('<button type="submit" class="adminsubmit '+f+'">'+c+"</button>");$(this.attributes).each(function(g,i){switch(i.name){case"type":break;case"class":var h=i.value.replace(/(^|\s*)ui-\S+/g,"");if(h!==""){e.attr("class","adminsubmit "+f+" "+h)}break;default:e.attr(i.name,i.value);break}});d.replaceWith(e)}});$("a.pageback").addClass("link_button icon back")},updateDisplay:function(){var d=$("#pg_menu");var e=$("#admin-alerts");var c=$("header.header");var f=c.outerHeight()+c.offset().top;if(e.length){f=e.outerHeight()+e.offset().top}console.debug("menu height = "+d.outerHeight()+" offset = "+f);console.debug("window height = "+$(window).height());if(d.outerHeight()+f<$(window).height()){console.debug("fixed");d.css({position:"fixed",top:f})}else{d.css({position:"",top:""});console.debug("floating");if(d.offset().top<$(window).scrollTop()){$("html, body").animate({scrollTop:$("#pg_menu").offset().top},1000)}}},_showSidebar:function(d,c){d.addClass("sidebar-on").removeClass("sidebar-off");c.find("li.current ul").show();this.setStorageValue("sidebar-pref","sidebar-on",60)},_closeSidebar:function(d,c){d.removeClass("sidebar-on").addClass("sidebar-off");c.find("li ul").hide();this.setStorageValue("sidebar-pref","sidebar-off",60)},_handleAlert:function(c){var e=$(c).closest(".alert-box");var d=e.data("alert-name");if(!d){return}return $.ajax({method:"POST",url:cms_data.ajax_alerts_url,data:{op:"delete",alert:d}}).done(function(){e.slideUp(1000);var f=e.parent();if(f.children().length<=1){e.closest("div.ui-dialog-content").dialog("close");$("#alert-noalerts").show();$("a#alerts").closest("li").remove()}e.remove()}).fail(function(h,f,g){console.debug("problem deleting an alert: "+g)})},setupAlerts:function(){var c=this;$("a#alerts").click(function(d){d.preventDefault();$("#alert-dialog").dialog()});$(".alert-msg a").click(function(d){d.preventDefault();c.handleAlert(d.target)});$(".alert-icon,.alert-remove").click(function(d){d.preventDefault();c._handleAlert(d.target)})}}})(this,jQuery);