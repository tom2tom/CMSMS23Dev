!function($){$.widget("cmsms.lockManager",{options:{touch_handler:null,lostlock_handler:null,error_handler:null,change_noticed:0,lock_timeout:60,lock_refresh:60},_settings:{locked:0,lock_id:-1,lock_expires:-1},_error_handler:function(t){if("string"==typeof t){var o="error_lock_"+t,s="Unknown Error";void 0!==this._settings.lang[o]&&(s=this._settings.lang[o]),t={type:t,msg:s}}"function"==typeof this.options.error_handler?this.options.error_handler(t):console.debug("Error: "+t.type+" - "+t.msg)},_lostlock_handler:function(t){"function"==typeof this.options.lostlock_handler&&this.options.lostlock_handler(t),console.debug("Error: "+t.type+" - "+t.msg)},_create:function(){if(this.options.lock_refresh=Math.max(this.options.lock_refresh,30),this.options.lock_refresh=Math.min(this.options.lock_refresh,3600),void 0!==cms_data.secure_param_name&&(this.options.secure_param=cms_data.secure_param_name),void 0!==cms_data.user_key&&(this.options.user_key=cms_data.user_key),void 0!==cms_data.admin_url&&(this.options.admin_url=cms_data.admin_url),!this.options.secure_param)throw"The secure_param option (string) must be set in the cmsms_lock plugin";if(!this.options.user_key)throw"The user_key option (string) must be set in the cmsms_lock plugin";if(!this.options.admin_url)throw"The admin_url option (string) must be set in the cmsms_lock plugin";if(!this.options.type)throw"The type option (string) must be set in a cmsms_lock plugin";if(!this.options.oid)throw"The oid option (integer) must be set in a cmsms_lock plugin";if(!this.options.uid)throw"The uid option (string) must be set in the cmsms_lock plugin";var t=this,o=this.options.admin_url+"/ajax_lock.php?cmsjobtype=1",s={opt:"setup"};s[this.options.secure_param]=this.options.user_key,s.uid=this.options.uid,$.post(o,s,function(s,e,i){if("success"!=e)throw"Problem communicating with ajax url "+o;"error"==s.status&&t._error_handler(s.error),t._settings=s,t._settings.ajax_url=o,t.options.change_noticed=0,void 0!==s.uid&&t.options.uid==s.uid?t.options.lock_timeout&&(t._setup_handlers(),t._lock()):t._error_handler("useridmismatch")})},_setup_touch:function(){var t=this,o=t.options.lock_refresh;o=Math.min(3600,Math.max(5,o)),void 0!==t._settings.touch_timer&&clearTimeout(t._settings.touch_timer),t._settings.touch_timer=setTimeout(function(){t._touch()},1e3*o)},_setup_handlers:function(){var t=this;this._settings.touch_skipped=0,this.element.on("change","input:not([type=submit]), select, textarea",function(){t.options.change_noticed=1,t._settings.touch_skipped&&t._touch()}),this.options.lock_refresh>0&&this._setup_touch()},_touch:function(){var t=this;if(t.options.change_noticed&&t._settings.locked&&t._settings.lock_id>0){console.debug("lockmanager: touching lock"),this._settings.touch_skipped=0;var o={opt:"touch"};o[this.options.secure_param]=this.options.user_key,o.type=this.options.type,o.oid=this.options.oid,o.uid=this.options.uid,o.lock_id=this._settings.lock_id,$.post(t._settings.ajax_url,o,function(o,s,e){if("success"!=s)throw"Problem communicating with ajax url "+t._settings.ajax_url;if("error"==o.status)return"cmsnolockexception"==o.error.type?t._lostlock_handler(o.error):t._error_handler(o.error),t._settings.locked=0,t._settings.lock_id=-1,void(t._settings.lock_expires=-1);t.options.touch_handler&&t.options.touch_handler(),t._settings.lock_expires=o.lock_expires,t.options.change_noticed=0})}else this._settings.touch_skipped=1;this._setup_touch()},_lock:function(){var t=this;if(!t._settings.locked){var o={opt:"lock"};o[this.options.secure_param]=this.options.user_key,o.type=this.options.type,o.oid=this.options.oid,o.uid=this.options.uid,o.lifetime=this.options.lock_timeout,$.post(t._settings.ajax_url,o,function(o,s,e){if("success"!=s)throw"Problem communicating with ajax url "+t._settings.ajax_url;"error"!=o.status?(t.options.lock_handler&&t.options.lock_handler(),t._settings.lock_id=o.lock_id,t._settings.lock_expires=o.lock_expires,t._settings.locked=1):t._error_handler(o.error)})}},relock:function(){this._lock()},unlock:function(t){var o=this;if(o._settings.locked&&o._settings.lock_id>0){var s={opt:"unlock"};if(s[this.options.secure_param]=this.options.user_key,s.type=this.options.type,s.oid=this.options.oid,s.uid=this.options.uid,s.lock_id=this._settings.lock_id,!t&&navigator.sendBeacon){var e=new FormData;for(var i in s)s.hasOwnProperty(i)&&e.append(i,s[i]);if(navigator.sendBeacon(o._settings.ajax_url,e)){o._settings.locked=0,o._settings.lock_id=-1,o._settings.lock_expires=-1;var n={status:"success"};return $.Deferred().resolve(n,"")}console.debug("unlock beacon failed... fallback to ajax")}return $.ajax({type:"POST",url:o._settings.ajax_url,cache:!1,data:s}).pipe(function(t,o,s){return 200!=s.status?$.Deferred().reject(t,o):"success"!=o?$.Deferred().reject(t,o):"error"==t.status?$.Deferred().reject(t,o):void 0}).done(function(t,s){o.options.unlock_handler&&o.options.unlock_handler(),o._settings.locked=0,o._settings.lock_id=-1,o._settings.lock_expires=-1}).fail(function(t,o,s){console.debug("unlock failed: "+o+" // "+s+" // "+t.status),setTimeout(function(){},3e3)})}n={status:"success"};return $.Deferred().resolve(n,"")},_noop:function(){}})}(jQuery);