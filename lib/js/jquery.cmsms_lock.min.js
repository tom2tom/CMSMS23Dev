(function(a){a.widget("cmsms.lockManager",{options:{touch_handler:null,lostlock_handler:null,error_handler:null,change_noticed:0,lock_timeout:60,lock_refresh:60},_settings:{locked:0,lock_id:-1,lock_expires:-1},_error_handler:function(b){if(typeof b==="string"){var c="error_lock_"+b;var d="Unknown Error";if(typeof this._settings.lang[c]!="undefined"){d=this._settings.lang[c]}b={type:b,msg:d}}if(typeof this.options.error_handler==="function"){this.options.error_handler(b)}else{console.debug("Error: "+b.type+" - "+b.msg)}},_lostlock_handler:function(b){if(typeof this.options.lostlock_handler==="function"){this.options.lostlock_handler(b)}console.debug("Error: "+b.type+" - "+b.msg)},_create:function(){this.options.lock_refresh=Math.max(this.options.lock_refresh,30);this.options.lock_refresh=Math.min(this.options.lock_refresh,3600);if(typeof cms_data.secure_param_name!=="undefined"){this.options.secure_param=cms_data.secure_param_name}if(typeof cms_data.user_key!=="undefined"){this.options.user_key=cms_data.user_key}if(typeof cms_data.admin_url!=="undefined"){this.options.admin_url=cms_data.admin_url}if(!this.options.secure_param){throw"The secure_param option (string) must be set in the cmsms_lock plugin"}if(!this.options.user_key){throw"The user_key option (string) must be set in the cmsms_lock plugin"}if(!this.options.admin_url){throw"The admin_url option (string) must be set in the cmsms_lock plugin"}if(!this.options.type){throw"The type option (string) must be set in a cmsms_lock plugin"}if(!this.options.oid){throw"The oid option (integer) must be set in a cmsms_lock plugin"}if(!this.options.uid){throw"The uid option (string) must be set in the cmsms_lock plugin"}var c=this;var b=this.options.admin_url+"/ajax_lock.php?cmsjobtype=1";var d={};d.opt="setup";d[this.options.secure_param]=this.options.user_key;d.uid=this.options.uid;a.post(b,d,function(f,g,e){if(g!="success"){throw"Problem communicating with ajax url "+b}if(f.status=="error"){c._error_handler(f.error)}c._settings=f;c._settings.ajax_url=b;c.options.change_noticed=0;if(typeof f.uid==="undefined"||c.options.uid!=f.uid){c._error_handler("useridmismatch");return}if(c.options.lock_timeout){c._setup_handlers();c._lock()}})},_setup_touch:function(){var c=this;var b=c.options.lock_refresh;b=Math.min(3600,Math.max(5,b));if(typeof c._settings.touch_timer!=="undefined"){clearTimeout(c._settings.touch_timer)}c._settings.touch_timer=setTimeout(function(){c._touch()},b*1000)},_setup_handlers:function(){var b=this;this._settings.touch_skipped=0;this.element.on("change","input:not([type=submit]), select, textarea",function(){b.options.change_noticed=1;if(b._settings.touch_skipped){b._touch()}});if(this.options.lock_refresh>0){this._setup_touch()}},_touch:function(){var b=this;if(b.options.change_noticed&&b._settings.locked&&b._settings.lock_id>0){console.debug("lockmanager: touching lock");this._settings.touch_skipped=0;var c={};c.opt="touch";c[this.options.secure_param]=this.options.user_key;c.type=this.options.type;c.oid=this.options.oid;c.uid=this.options.uid;c.lock_id=this._settings.lock_id;a.post(b._settings.ajax_url,c,function(e,f,d){if(f!="success"){throw"Problem communicating with ajax url "+b._settings.ajax_url}if(e.status=="error"){if(e.error.type=="cmsnolockexception"){b._lostlock_handler(e.error)}else{b._error_handler(e.error)}b._settings.locked=0;b._settings.lock_id=-1;b._settings.lock_expires=-1;return}if(b.options.touch_handler){b.options.touch_handler()}b._settings.lock_expires=e.lock_expires;b.options.change_noticed=0})}else{this._settings.touch_skipped=1}this._setup_touch()},_lock:function(){var b=this;if(!b._settings.locked){var c={};c.opt="lock";c[this.options.secure_param]=this.options.user_key;c.type=this.options.type;c.oid=this.options.oid;c.uid=this.options.uid;c.lifetime=this.options.lock_timeout;a.post(b._settings.ajax_url,c,function(e,f,d){if(f!="success"){throw"Problem communicating with ajax url "+b._settings.ajax_url}if(e.status=="error"){b._error_handler(e.error);return}if(b.options.lock_handler){b.options.lock_handler()}b._settings.lock_id=e.lock_id;b._settings.lock_expires=e.lock_expires;b._settings.locked=1})}},relock:function(){this._lock()},unlock:function(h){var b=this;if(b._settings.locked&&b._settings.lock_id>0){var f={};f.opt="unlock";f[this.options.secure_param]=this.options.user_key;f.type=this.options.type;f.oid=this.options.oid;f.uid=this.options.uid;f.lock_id=this._settings.lock_id;if(!h&&navigator.sendBeacon){var g=new FormData();for(var i in f){if(f.hasOwnProperty(i)){g.append(i,f[i])}}var e=navigator.sendBeacon(b._settings.ajax_url,g);if(e){b._settings.locked=0;b._settings.lock_id=-1;b._settings.lock_expires=-1;var d={status:"success"};return a.Deferred().resolve(d,"")}console.debug("unlock beacon failed... fallback to ajax")}var c=a.ajax({type:"POST",url:b._settings.ajax_url,cache:false,data:f}).pipe(function(j,l,k){if(k.status!=200){return a.Deferred().reject(j,l)}if(l!="success"){return a.Deferred().reject(j,l)}if(j.status=="error"){return a.Deferred().reject(j,l)}}).done(function(j,k){if(b.options.unlock_handler){b.options.unlock_handler()}b._settings.locked=0;b._settings.lock_id=-1;b._settings.lock_expires=-1}).fail(function(k,l,j){console.debug("unlock failed: "+l+" // "+j+" // "+k.status);setTimeout(function(){},3000)});return c}else{var d={status:"success"};return a.Deferred().resolve(d,"")}},_noop:function(){}})})(jQuery);