/*!
jQuery autoRefresh widget v.1.1
(C) 2014-2019 CMS Made Simple Foundation <foundation@cmsmadesimple.org>
License GPL2+
*/
!function($,t,s,e){$.widget("cmsms.autoRefresh",{options:{url:null,data:null,interval:30,start_handler:null,done_handler:null},settings:{timer:null,focus:-1,lastrefresh:null},_create:function(){if(!this.options.url)throw"An URL must be specified for the autoRefresh widget";var t=this.options.interval;if(t<1||t>3600)throw"The autoRefresh widget refresh-interval must be in the range 1 to 3600";s.contains(this.element[0])&&this.element.find(":input,a").on("click",function(){e.start()});var e=this;$(s).on("focus",function(){e.settings.focus<1&&(e.settings.focus=1,Date.now()/1e3-e.settings.lastrefresh>=e.options.interval&&(e.start(),e.refresh()))}),$(s).on("blur",function(){1===e.settings.focus&&(e.settings.focus=0)}),this.start(),this.refresh()},_setOption:function(t,s){switch(t){case"url":"string"==typeof s&&s.length>0&&(this.options.url=s),this.start();break;case"data":return this.options.data=s,this.start(),this.refresh();case"interval":var e=parseInt(s);e>0&&(this.options.url=Math.min(e,3600)),this.start();break;case"start_handler":this.options.start_handler="function"==typeof s?s:null;break;case"done_handler":this.options.done_handler="function"==typeof s?s:null}},stop:function(){this.settings.timer&&(clearInterval(this.settings.timer),this.settings.timer=null)},start:function(){var t=this;t.stop(),t.settings.timer=setInterval(function(){t.refresh()},1e3*t.options.interval)},reset:function(){this.start()},refresh:function(){var t=this;if(t.settings.focus){var e=Date.now()/1e3;t.settings.lastrefresh=e,t.options.start_handler&&t.options.start_handler(),cms_busy(),$.ajax(t.options.url,{data:t.options.data,cache:!1}).fail(function(t,s,e){console.debug("autorefresh failed")}).done(function(e){console.debug("autorefresh success"),s.contains(t.element[0])&&t.element.html(e),"function"==typeof t.options.done_handler&&t.options.done_handler(e)}).always(function(){cms_busy(!1)})}}})}(jQuery,window,document);
