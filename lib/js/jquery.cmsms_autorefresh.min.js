(function(a){a.widget("cmsms.autoRefresh",{options:{url:null,data:null,interval:30,start_handler:null,done_handler:null},settings:{timer:null,focus:-1,lastrefresh:null},_create:function(){var c=this;if(!this.options.url){throw"A URL must be specified for the autoRefresh plugin"}var b=this.options.interval;if(b<1||b>3600){throw"autoRefresh interval must be between 1 and 3600"}a(this.element).on("click",":input",function(){c.start()});a(this.element).on("click","a",function(){c.start()});a(window).focus(function(){if(c.settings.focus<1){c.settings.focus=1;var d=Date.now()/1000;var e=d-c.settings.lastrefresh;if(e>=c.options.interval){c.start();c.refresh()}}});a(window).blur(function(){if(c.settings.focus===1){c.settings.focus=0}});this.start();this.refresh()},_setOption:function(c,d){switch(c){case"url":if(typeof d==="string"&&d.length>0){this.options.url=d}this.start();break;case"data":this.options.data=d;this.start();return this.refresh();case"interval":var b=parseInt(d);if(b>0){this.options.url=Math.min(b,3600)}this.start();break;case"start_handler":if(typeof d==="function"){this.options.start_handler=d}else{this.options.start_handler=null}break;case"done_handler":if(typeof d==="function"){this.options.done_handler=d}else{this.options.done_handler=null}}},stop:function(){var b=this;if(b.settings.timer){clearInterval(this.settings.timer);b.settings.timer=null}},start:function(){var b=this;b.stop();b.settings.timer=setInterval(function(){b.refresh()},b.options.interval*1000)},reset:function(){this.start()},refresh:function(){var c=this;if(!c.settings.focus){return}var b=Date.now()/1000;c.settings.lastrefresh=b;if(c.options.start_handler){c.options.start_handler()}cms_busy();return a.ajax({url:c.options.url,data:c.options.data,cache:false}).then(function(d){cms_busy(false);return d}).fail(function(d,f,e){console.debug("autorefresh failed")}).done(function(d){console.debug("autorefresh success");a(c.element).html(d);if(typeof c.options.done_handler==="function"){c.options.done_handler(d)}})}})})(jQuery);