(function(a){a.widget("cmsms.hierselector",{options:{current:null,value:null,allowcurrent:true,use_perms:false,use_simple:false,allow_all:false,for_child:false,is_manager:false},_create:function(){if(typeof(cms_data.secure_param_name)!="undefined"){this.options.secure_param=cms_data.secure_param_name}if(typeof(cms_data.user_key)!="undefined"){this.options.user_key=cms_data.user_key}if(typeof(cms_data.admin_url)!="undefined"){this.options.admin_url=cms_data.admin_url}if(!this.options.secure_param){throw"The secure_param option (string) must be set in the cmsms_lock plugin"}if(!this.options.user_key){throw"The user_key option (string) must be set in the cmsms_lock plugin"}if(!this.options.admin_url){throw"The admin_url option (string) must be set in the cmsms_lock plugin"}var b=this;this.data={};this.data.orig_val=this.element.val();this.data.name=this.element.attr("name");this.data.id=this.element.attr("id");this.data.hidden_e=a('<input type="hidden" name="'+this.data.name+'" value="'+this.data.orig_val+'"/>').insertAfter(this.element);this.data.ajax_url=this.options.admin_url+"/ajax_content.php?"+this.options.secure_param+"="+this.options.user_key;this.element.val("").removeAttr("name").attr("readonly","readonly").hide();a.ajax({url:this.data.ajax_url+"&t="+a.now(),data:{op:"pageinfo",page:this.data.orig_val},type:"GET"}).pipe(function(c,e,d){if(d.status!=200){return a.Deferred().reject(c)}if(typeof c.status=="undefined"||c.status!="success"){return a.Deferred().reject(c)}return c.data}).done(function(c){b.data.orig_idhier=c.id_hierarchy;b.data.orig_pages=c.id_hierarchy.split(".")}).always(function(c){b._setup_dropdowns()})},_setOption:function(c,b){this.options[c]=b;this._setup_dropdowns()},_setup_dropdowns:function(){if(this.options.use_simple){this._setup_simple_dropdown()}else{this._setup_smart_dropdowns()}},_build_simple_select:function(b,g,e,k){var l=this;var d=a("<select></select>").attr("id",b).addClass("cms_selhier").attr("title",cms_lang("hierselect_title"));d.on("change",function(){var i=a(this).val();a(this).trigger("cmsms_formchange",{elem:a(this),value:i})});for(var h=0;h<g.length;h++){var f=g[h].hierarchy.split(".").length;var j="&nbsp;&nbsp;".repeat(f-1)+g[h].display;var c=a("<option>"+j+"</option>").attr("value",g[h].content_id);if(g[h].content_id==e){c.attr("selected","selected").addClass("selected")}if(g[h].content_id==k){c.addClass("hilite")}if(g[h].content_id==this.options.value&&!this.options.allowcurrent){c.attr("disabled","disabled")}if(this.options.use_perms&&!g[h].can_edit){c.attr("disabled","disabled").addClass("nochildren")}d.append(c)}return d},_build_smart_select:function(b,g,e,j,h){var k=this;var d=a("<select></select>").attr("id",b).addClass("cms_selhier").attr("title",cms_lang("hierselect_title"));d.on("change",function(){var i=a(this).val();if(i<1){i=a(this).prev("select").val();if(typeof(i)=="undefined"){i=-1}}k.data.hidden_e.val(i).change();k._setup_smart_dropdowns();a(this).trigger("cmsms_formchange",{elem:a(this),value:i})});if(j){var c=a("<option>"+cms_lang("none")+"</option>").attr("value",-1);d.append(c)}for(var f=0;f<g.length;f++){var c=a("<option>"+g[f].display+"</option>").attr("value",g[f].content_id);if(g[f].content_id==e){c.attr("selected","selected").addClass("selected")}if(g[f].content_id==h){c.addClass("hilite")}if(g[f].content_id==this.options.value&&!this.options.allowcurrent){c.attr("disabled","disabled")}if(!g[f].has_children&&this.options.use_perms&&!g[f].can_edit){c.attr("disabled","disabled").addClass("nochildren")}if(this.options.for_child&&!g[f].has_children&&!g[f].wants_children){c.attr("disabled","disabled").addClass("nochildren")}d.append(c)}return d},_setup_smart_dropdowns:function(){var c=this;var b=this.data.hidden_e.val();c.element.prevAll("select.cms_selhier").remove();c.element.val("");var d=this.options;d.op="here_up";d.page=b;a.ajax({url:this.data.ajax_url+"&t="+a.now(),data:d,type:"GET"}).pipe(function(e,g,f){if(f.status!=200){return a.Deferred().reject(e)}if(typeof e.status=="undefined"||e.status!="success"){return a.Deferred().reject(e)}return e.data}).done(function(k){var m,f=false;var n=true;if(c.options.for_child&&c.options.use_perms&&!c.options.is_manager){n=false}for(var g=0;g<k.length&&!m;g++){for(var e=0;e<k[g].length&&!m;e++){if(k[g][e].content_id==b){m=k[g][e].id_hierarchy;break}}}if(m){f=m.split(".")}for(var l=0;l<k.length;l++){if(k[l]==null){break}var j=(l<f.length)?f[l]:-1;var i=(c.data.orig_pages&&l<c.data.orig_pages.length)?c.data.orig_pages[l]:-100;var h=c._build_smart_select(c.data.id+"_"+l,k[l],j,n,i);if(j){for(var e=0;e<k[l].length;e++){if(k[l][e].content_id==j){n=k[l][e].wants_children;if(!c.options.for_child&&!k[l][e].has_usable_link){n=false}if(c.options.for_child&&c.options.use_perms&&!c.options.is_manager&&!k[l][e].can_edit){n=false}break}}}h.insertBefore(c.element)}})},_setup_simple_dropdown:function(){var c=this;var b=this.data.hidden_e.val();var d=this.options;d.op="userpages";a.ajax({url:this.data.ajax_url+"&t="+a.now(),data:d,type:"GET"}).pipe(function(e,g,f){if(f.status!=200){return a.Deferred().reject(e)}if(typeof e.status=="undefined"||e.status!="success"){return a.Deferred().reject(e)}return e.data}).done(function(f){var e=c._build_simple_select(c.data.id+"_0",f,b,true,-1);e.insertBefore(c.element)})},_noop:function(){}})})(jQuery);