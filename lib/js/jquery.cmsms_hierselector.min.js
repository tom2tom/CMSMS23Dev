!function($){$.widget("cmsms.hierselector",{options:{current:null,value:null,allowcurrent:!0,use_perms:!1,use_simple:!1,allow_all:!1,for_child:!1,is_manager:!1},_create:function(){if(void 0!==cms_data.secure_param_name&&(this.options.secure_param=cms_data.secure_param_name),void 0!==cms_data.user_key&&(this.options.user_key=cms_data.user_key),void 0!==cms_data.admin_url&&(this.options.admin_url=cms_data.admin_url),!this.options.secure_param)throw"The secure_param option (string) must be set in the cmsms_lock plugin";if(!this.options.user_key)throw"The user_key option (string) must be set in the cmsms_lock plugin";if(!this.options.admin_url)throw"The admin_url option (string) must be set in the cmsms_lock plugin";var t=this;this.data={},this.data.orig_val=this.element.val(),this.data.name=this.element.attr("name"),this.data.id=this.element.attr("id"),this.data.hidden_e=$('<input type="hidden" name="'+this.data.name+'" value="'+this.data.orig_val+'"/>').insertAfter(this.element),this.data.ajax_url=this.options.admin_url+"/ajax_content.php?"+this.options.secure_param+"="+this.options.user_key,this.element.val("").removeAttr("name").attr("readonly","readonly").hide(),$.ajax({url:this.data.ajax_url+"&t="+$.now(),data:{op:"pageinfo",page:this.data.orig_val},type:"GET"}).pipe(function(t,e,s){return 200!=s.status?$.Deferred().reject(t):void 0===t.status||"success"!=t.status?$.Deferred().reject(t):t.data}).done(function(e){t.data.orig_idhier=e.id_hierarchy,t.data.orig_pages=e.id_hierarchy.split(".")}).always(function(e){t._setup_dropdowns()})},_setOption:function(t,e){this.options[t]=e,this._setup_dropdowns()},_setup_dropdowns:function(){this.options.use_simple?this._setup_simple_dropdown():this._setup_smart_dropdowns()},_build_simple_select:function(t,e,s,a){var i=$("<select></select>").attr("id",t).addClass("cms_selhier").attr("title",cms_lang("hierselect_title"));i.on("change",function(){var t=$(this).val();$(this).trigger("cmsms_formchange",{elem:$(this),value:t})});for(var n=0;n<e.length;n++){var r=e[n].hierarchy.split(".").length,o="&nbsp;&nbsp;".repeat(r-1)+e[n].display,d=$("<option>"+o+"</option>").attr("value",e[n].content_id);e[n].content_id==s&&d.attr("selected","selected").addClass("selected"),e[n].content_id==a&&d.addClass("hilite"),e[n].content_id!=this.options.value||this.options.allowcurrent||d.attr("disabled","disabled"),this.options.use_perms&&!e[n].can_edit&&d.attr("disabled","disabled").addClass("nochildren"),i.append(d)}return i},_build_smart_select:function(t,e,s,a,i){var n=this,r=$("<select></select>").attr("id",t).addClass("cms_selhier").attr("title",cms_lang("hierselect_title"));if(r.on("change",function(){var t=$(this).val();t<1&&void 0===(t=$(this).prev("select").val())&&(t=-1),n.data.hidden_e.val(t).change(),n._setup_smart_dropdowns(),$(this).trigger("cmsms_formchange",{elem:$(this),value:t})}),a){var o=$("<option>"+cms_lang("none")+"</option>").attr("value",-1);r.append(o)}for(var d=0;d<e.length;d++){o=$("<option>"+e[d].display+"</option>").attr("value",e[d].content_id);e[d].content_id==s&&o.attr("selected","selected").addClass("selected"),e[d].content_id==i&&o.addClass("hilite"),e[d].content_id!=this.options.value||this.options.allowcurrent||o.attr("disabled","disabled"),e[d].has_children||!this.options.use_perms||e[d].can_edit||o.attr("disabled","disabled").addClass("nochildren"),!this.options.for_child||e[d].has_children||e[d].wants_children||o.attr("disabled","disabled").addClass("nochildren"),r.append(o)}return r},_setup_smart_dropdowns:function(){var t=this,e=this.data.hidden_e.val();t.element.prevAll("select.cms_selhier").remove(),t.element.val("");var s=this.options;s.op="here_up",s.page=e,$.ajax({url:this.data.ajax_url+"&t="+$.now(),data:s,type:"GET"}).pipe(function(t,e,s){return 200!=s.status?$.Deferred().reject(t):void 0===t.status||"success"!=t.status?$.Deferred().reject(t):t.data}).done(function(s){var a,i=!1,n=!0;t.options.for_child&&t.options.use_perms&&!t.options.is_manager&&(n=!1);for(var r=0;r<s.length&&!a;r++)for(var o=0;o<s[r].length&&!a;o++)if(s[r][o].content_id==e){a=s[r][o].id_hierarchy;break}a&&(i=a.split("."));for(var d=0;d<s.length&&null!=s[d];d++){var l=d<i.length?i[d]:-1,_=t.data.orig_pages&&d<t.data.orig_pages.length?t.data.orig_pages[d]:-100,c=t._build_smart_select(t.data.id+"_"+d,s[d],l,n,_);if(l)for(o=0;o<s[d].length;o++)if(s[d][o].content_id==l){n=s[d][o].wants_children,t.options.for_child||s[d][o].has_usable_link||(n=!1),t.options.for_child&&t.options.use_perms&&!t.options.is_manager&&!s[d][o].can_edit&&(n=!1);break}c.insertBefore(t.element)}})},_setup_simple_dropdown:function(){var t=this,e=this.data.hidden_e.val(),s=this.options;s.op="userpages",$.ajax({url:this.data.ajax_url+"&t="+$.now(),data:s,type:"GET"}).pipe(function(t,e,s){return 200!=s.status?$.Deferred().reject(t):void 0===t.status||"success"!=t.status?$.Deferred().reject(t):t.data}).done(function(s){t._build_simple_select(t.data.id+"_0",s,e,!0,-1).insertBefore(t.element)})},_noop:function(){}})}(jQuery);