/*!
jQuery UI Nested Sortable v 2.1a <https://github.com/ilikenwf/nestedSortable>
(C) 2010-2018 Manuele J Sarfatti and contributors
License: MIT
*/
(function(a){if(typeof define==="function"&&define.amd){define(["jquery","jquery-ui/ui/sortable"],a)}else{a(window.jQuery)}}(function($){"use strict";function a(c,b,d){return(c>b)&&(c<(b+d))}$.widget("mjs.nestedSortable",$.extend({},$.ui.sortable.prototype,{options:{disableParentChange:false,doNotClear:false,expandOnHover:700,isAllowed:function(){return true},isTree:false,listType:"ol",maxLevels:0,protectRoot:false,rootID:null,rtl:false,startCollapsed:false,tabSize:20,branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf",disabledClass:"mjs-nestedSortable-disabled"},_create:function(){var b=this,c;this.element.data("ui-sortable",this.element.data("mjs-nestedSortable"));if(!this.element.is(this.options.listType)){c="nestedSortable: Please check that the listType option is set to your actual list type";throw new Error(c)}if(this.options.isTree&&this.options.expandOnHover){this.options.tolerance="intersect"}$.ui.sortable.prototype._create.apply(this,arguments);if(this.options.isTree){$(this.items).each(function(){var f=this.item,d=f.hasClass(b.options.collapsedClass),e=f.hasClass(b.options.expandedClass);if(f.children(b.options.listType).length){f.addClass(b.options.branchClass);if(!d&&!e){if(b.options.startCollapsed){f.addClass(b.options.collapsedClass)}else{f.addClass(b.options.expandedClass)}}}else{f.addClass(b.options.leafClass)}})}},_destroy:function(){this.element.removeData("mjs-nestedSortable").removeData("ui-sortable");return $.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(p){var q,s,u,g,k=this,l=this.options,c=false,w=$(document),h,j,b,t,n,m,e,d,v,r,f,x;this.position=this._generatePosition(p);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){if(this.scrollParent[0]!==document&&this.scrollParent[0].tagName!=="HTML"){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-p.pageY<l.scrollSensitivity){c=this.scrollParent.scrollTop()+l.scrollSpeed;this.scrollParent.scrollTop(c)}else{if(p.pageY-this.overflowOffset.top<l.scrollSensitivity){c=this.scrollParent.scrollTop()-l.scrollSpeed;this.scrollParent.scrollTop(c)}}if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-p.pageX<l.scrollSensitivity){c=this.scrollParent.scrollLeft()+l.scrollSpeed;this.scrollParent.scrollLeft(c)}else{if(p.pageX-this.overflowOffset.left<l.scrollSensitivity){c=this.scrollParent.scrollLeft()-l.scrollSpeed;this.scrollParent.scrollLeft(c)}}}else{if(p.pageY-w.scrollTop()<l.scrollSensitivity){c=w.scrollTop()-l.scrollSpeed;w.scrollTop(c)}else{if($(window).height()-(p.pageY-w.scrollTop())<l.scrollSensitivity){c=w.scrollTop()+l.scrollSpeed;w.scrollTop(c)}}if(p.pageX-w.scrollLeft()<l.scrollSensitivity){c=w.scrollLeft()-l.scrollSpeed;w.scrollLeft(c)}else{if($(window).width()-(p.pageX-w.scrollLeft())<l.scrollSensitivity){c=w.scrollLeft()+l.scrollSpeed;w.scrollLeft(c)}}}if(c!==false&&$.ui.ddmanager&&!l.dropBehaviour){$.ui.ddmanager.prepareOffsets(this,p)}}this.positionAbs=this._convertPositionTo("absolute");h=this.placeholder.offset().top;if(!this.options.axis||this.options.axis!=="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!=="x"){this.helper[0].style.top=(this.position.top)+"px"}this.hovering=this.hovering?this.hovering:null;this.mouseentered=this.mouseentered?this.mouseentered:false;(function(){var i=this.placeholder.parent().parent();if(i&&i.closest(".ui-sortable").length){j=i}}.call(this));b=this._getLevel(this.placeholder);t=this._getChildLevels(this.helper);e=document.createElement(l.listType);for(q=this.items.length-1;q>=0;q--){s=this.items[q];u=s.item[0];g=this._intersectsWithPointer(s);if(!g){continue}if(s.instance!==this.currentContainer){continue}if(u.className.indexOf(l.disabledClass)!==-1){if(g===2){n=this.items[q+1];if(n&&n.item.hasClass(l.disabledClass)){continue}}else{if(g===1){m=this.items[q-1];if(m&&m.item.hasClass(l.disabledClass)){continue}}}}d=g===1?"next":"prev";if(u!==this.currentItem[0]&&this.placeholder[d]()[0]!==u&&!$.contains(this.placeholder[0],u)&&(this.options.type==="semi-dynamic"?!$.contains(this.element[0],u):true)){if(!this.mouseentered){$(u).mouseenter();this.mouseentered=true}if(l.isTree&&$(u).hasClass(l.collapsedClass)&&l.expandOnHover){if(!this.hovering){$(u).addClass(l.hoveringClass);this.hovering=window.setTimeout(function(){$(u).removeClass(l.collapsedClass).addClass(l.expandedClass);k.refreshPositions();k._trigger("expand",p,[k._uiHash(),u])},l.expandOnHover)}}this.direction=g===1?"down":"up";if(this.options.tolerance==="pointer"||this._intersectsWithSides(s)){$(u).mouseleave();this.mouseentered=false;$(u).removeClass(l.hoveringClass);if(this.hovering){window.clearTimeout(this.hovering)}this.hovering=null;if(l.protectRoot&&!(this.currentItem[0].parentNode===this.element[0]&&u.parentNode!==this.element[0])){if(this.currentItem[0].parentNode!==this.element[0]&&u.parentNode===this.element[0]){if(!$(u).children(l.listType).length){u.appendChild(e);if(l.isTree){$(u).removeClass(l.leafClass).addClass(l.branchClass+" "+l.expandedClass)}}if(this.direction==="down"){v=$(u).prev().children(l.listType)}else{v=$(u).children(l.listType)}if(v[0]!==undefined){this._rearrange(p,null,v)}}else{this._rearrange(p,s)}}else{if(!l.protectRoot){this._rearrange(p,s)}}}else{break}this._clearEmpty(u);this._trigger("change",p,this._uiHash());break}}(function(){var i=this.placeholder.prev();if(i.length){r=i}else{r=null}}.call(this));if(r!=null){while(r[0].nodeName.toLowerCase()!=="li"||r[0].className.indexOf(l.disabledClass)!==-1||r[0]===this.currentItem[0]||r[0]===this.helper[0]){if(r[0].previousSibling){r=$(r[0].previousSibling)}else{r=null;break}}}(function(){var i=this.placeholder.next();if(i.length){f=i}else{f=null}}.call(this));if(f!=null){while(f[0].nodeName.toLowerCase()!=="li"||f[0].className.indexOf(l.disabledClass)!==-1||f[0]===this.currentItem[0]||f[0]===this.helper[0]){if(f[0].nextSibling){f=$(f[0].nextSibling)}else{f=null;break}}}this.beyondMaxLevels=0;if(j!=null&&f==null&&!(l.protectRoot&&j[0].parentNode==this.element[0])&&(l.rtl&&(this.positionAbs.left+this.helper.outerWidth()>j.offset().left+j.outerWidth())||!l.rtl&&(this.positionAbs.left<j.offset().left))){j.after(this.placeholder[0]);x=!j.children(l.listItem).children("li:visible:not(.ui-sortable-helper)").length;if(l.isTree&&x){j.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass)}if(typeof j!=="undefined"){this._clearEmpty(j[0])}this._trigger("change",p,this._uiHash())}else{if(r!=null&&!r.hasClass(l.disableNestingClass)&&(r.children(l.listType).length&&r.children(l.listType).is(":visible")||!r.children(l.listType).length)&&!(l.protectRoot&&this.currentItem[0].parentNode===this.element[0])&&(l.rtl&&(this.positionAbs.left+this.helper.outerWidth()<r.offset().left+r.outerWidth()-l.tabSize)||!l.rtl&&(this.positionAbs.left>r.offset().left+l.tabSize))){this._isAllowed(r,b,b+t+1);if(!r.children(l.listType).length){r[0].appendChild(e);if(l.isTree){r.removeClass(l.leafClass).addClass(l.branchClass+" "+l.expandedClass)}}if(h&&(h<=r.offset().top)){r.children(l.listType).prepend(this.placeholder)}else{r.children(l.listType)[0].appendChild(this.placeholder[0])}if(typeof j!=="undefined"){this._clearEmpty(j[0])}this._trigger("change",p,this._uiHash())}else{this._isAllowed(j,b,b+t)}}this._contactContainers(p);if($.ui.ddmanager){$.ui.ddmanager.drag(this,p)}this._trigger("sort",p,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(b){if(this.beyondMaxLevels){this.placeholder.removeClass(this.options.errorClass);if(this.domPosition.prev){$(this.domPosition.prev).after(this.placeholder)}else{$(this.domPosition.parent).prepend(this.placeholder)}this._trigger("revert",b,this._uiHash())}$("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass);this.mouseentered=false;if(this.hovering){window.clearTimeout(this.hovering)}this.hovering=null;this._relocate_event=b;this._pid_current=$(this.domPosition.parent).parent().attr("id");this._sort_current=this.domPosition.prev?$(this.domPosition.prev).next().index():0;$.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(e){var f=this.options.isTree?0.8:0.5,c=a(this.positionAbs.top+this.offset.click.top,e.top+(e.height*f),e.height),h=a(this.positionAbs.top+this.offset.click.top,e.top-(e.height*f),e.height),d=a(this.positionAbs.left+this.offset.click.left,e.left+(e.width/2),e.width),b=this._getDragVerticalDirection(),g=this._getDragHorizontalDirection();if(this.floating&&g){return((g==="right"&&d)||(g==="left"&&!d))}else{return b&&((b==="down"&&c)||(b==="up"&&h))}},_contactContainers:function(){if(this.options.protectRoot&&this.currentItem[0].parentNode===this.element[0]){return}$.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(){var b,c;$.ui.sortable.prototype._clear.apply(this,arguments);if(!(this._pid_current===this._uiHash().item.parent().parent().attr("id")&&this._sort_current===this._uiHash().item.index())){this._trigger("relocate",this._relocate_event,this._uiHash())}for(b=this.items.length-1;b>=0;b--){c=this.items[b].item[0];this._clearEmpty(c)}},serialize:function(c){var e=$.extend({},this.options,c),b=this._getItemsAsjQuery(e&&e.connected),d=[];$(b).each(function(){var g=($(e.item||this).attr(e.attribute||"id")||"").match(e.expression||(/(.+)[-=_](.+)/)),f=($(e.item||this).parent(e.listType).parent(e.items).attr(e.attribute||"id")||"").match(e.expression||(/(.+)[-=_](.+)/));if(g){d.push(((e.key||g[1])+"["+(e.key&&e.expression?g[1]:g[2])+"]")+"="+(f?(e.key&&e.expression?f[1]:f[2]):e.rootID))}});if(!d.length&&e.key){d.push(e.key+"=")}return d.join("&")},toHierarchy:function(d){var e=$.extend({},this.options,d),c=[];$(this.element).children(e.items).each(function(){var f=b(this);c.push(f)});return c;function b(g){var i=($(g).attr(e.attribute||"id")||"").match(e.expression||(/(.+)[-=_](.+)/)),f;var h=$(g).data();if(h.nestedSortableItem){delete h.nestedSortableItem}if(i){f={id:i[2]};f=$.extend({},f,h);if($(g).children(e.listType).children(e.items).length>0){f.children=[];$(g).children(e.listType).children(e.items).each(function(){var j=b(this);f.children.push(j)})}return f}}},toArray:function(d){var g=$.extend({},this.options,d),b=g.startDepthCount||0,c=[],e=1;if(!g.excludeRoot){c.push({item_id:g.rootID,parent_id:null,depth:b,left:e,right:($(g.items,this.element).length+1)*2});e++}$(this.element).children(g.items).each(function(){e=f(this,b,e)});c=c.sort(function(i,h){return(i.left-h.left)});return c;function f(o,j,p){var n=p+1,h,l,i;if($(o).children(g.listType).children(g.items).length>0){j++;$(o).children(g.listType).children(g.items).each(function(){n=f($(this),j,n)});j--}h=($(o).attr(g.attribute||"id")||"").match(g.expression||(/(.+)[-=_](.+)/));if(j===b){l=g.rootID}else{i=($(o).parent(g.listType).parent(g.items).attr(g.attribute||"id")).match(g.expression||(/(.+)[-=_](.+)/));l=i[2]}if(h){var k=$(o).children("div").data();var m=$.extend(k,{id:h[2],parent_id:l,depth:j,left:p,right:n});c.push(m)}p=n+1;return p}},_clearEmpty:function(d){function c(j,i,h,k){if(k){i=[h,h=i][0]}$(j).removeClass(i).addClass(h)}var f=this.options,g=$(d).children(f.listType),b=g.has("li").length;var e=f.doNotClear||b||f.protectRoot&&$(d)[0]===this.element[0];if(f.isTree){c(d,f.branchClass,f.leafClass,e)}if(!e){g.parent().removeClass(f.expandedClass);g.remove()}},_getLevel:function(b){var d=1,c;if(this.options.listType){c=b.closest(this.options.listType);while(c&&c.length>0&&!c.is(".ui-sortable")){d++;c=c.parent().closest(this.options.listType)}}return d},_getChildLevels:function(d,f){var c=this,e=this.options,b=0;f=f||0;$(d).children(e.listType).children(e.items).each(function(g,h){b=Math.max(c._getChildLevels(h,f+1),b)});return f?b+1:b},_isAllowed:function(b,h,e){var g=this.options,c=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels"),d=this.currentItem.parent().parent(),f=g.disableParentChange&&(typeof b!=="undefined"&&!d.is(b)||typeof b==="undefined"&&d.is("li"));if(f||!g.isAllowed(this.placeholder,b,this.currentItem)){this.placeholder.addClass(g.errorClass);if(c<e&&c!==0){this.beyondMaxLevels=e-c}else{this.beyondMaxLevels=1}}else{if(c<e&&c!==0){this.placeholder.addClass(g.errorClass);this.beyondMaxLevels=e-c}else{this.placeholder.removeClass(g.errorClass);this.beyondMaxLevels=0}}}}));$.mjs.nestedSortable.prototype.options=$.extend({},$.ui.sortable.prototype.options,$.mjs.nestedSortable.prototype.options)}));