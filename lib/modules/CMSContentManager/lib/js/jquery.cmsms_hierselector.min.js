/*!
jQuery hierselector widget v.1.1
(C) 2014-2019 CMS Made Simple Foundation <foundation@cmsmadesimple.org>
License GPL2+
*/
!function($){$.widget("cmsms.hierselector",{options:{current:0,value:0,is_manager:!1,allow_current:!0,use_perms:!1,use_simple:!1,allow_all:!1,for_child:!1},_create:function(){this.data={},this.data.orig_val=this.element.val(),this.data.name=this.element.attr("name"),this.data.id=this.element.attr("id"),this.data.hidden_e=$('<input type="hidden" name="'+this.data.name+'" value="'+this.data.orig_val+'" />').insertAfter(this.element),this.data.ajax_url=cms_data.ajax_hiersel_url,this.element.val("").removeAttr("name").attr("readonly","readonly").hide();var t=this,e={m1_op:"pageinfo"};return e.m1_page=this.data.orig_val,$.ajax(this.data.ajax_url,{dataType:"json",data:e}).fail(function(t,e,a){console.debug("selector creation failed: "+a)}).done(function(e){if("success"===e.status){var a=e.data;t.data.orig_idhier=a.id_hierarchy;try{t.data.orig_pages=a.id_hierarchy.split(".")}catch(e){t.data.orig_pages=[a.id_hierarchy]}t._setup_dropdowns()}})},_setOption:function(t,e){this.options[t]=e,this._setup_dropdowns()},_setup_dropdowns:function(){this.options.use_simple?this._setup_simple_dropdown():this._setup_smart_dropdowns()},_build_simple_select:function(t,e,a,i){var s=$("<select></select>").attr("id",t).addClass("cms_selhier").attr("title",cms_lang("hierselect_title"));s.on("change",function(){var t=$(this).val();$(this).trigger("cmsms_formchange",{elem:$(this),value:t})});for(var n=0;n<e.length;n++){var o;try{o=e[n].hierarchy.split(".").length}catch(t){o=1}var r="&nbsp;&nbsp;".repeat(o-1)+e[n].display,d=$("<option>"+r+"</option>").attr("value",e[n].content_id);e[n].content_id===a&&d.attr("selected","selected").addClass("selected"),e[n].content_id===i&&d.addClass("hilite"),e[n].content_id!==this.options.value||this.options.allow_current||d.attr("disabled","disabled"),this.options.use_perms&&!e[n].can_edit&&d.attr("disabled","disabled").addClass("nochildren"),s.append(d)}return s},_build_smart_select:function(t,e,a,i,s){var n=this,o=$("<select></select>").attr("id",t).addClass("cms_selhier").attr("title",cms_lang("hierselect_title"));if(o.on("change",function(){var t=$(this).val();t<1&&void 0===(t=$(this).prev("select").val())&&(t=-1),n.data.hidden_e.val(t).change(),n._setup_smart_dropdowns(),$(this).trigger("cmsms_formchange",{elem:$(this),value:t})}),i){var r=$("<option>"+cms_lang("none")+"</option>").attr("value",-1);o.append(r)}for(var d=0;d<e.length;d++){r=$("<option>"+e[d].display+"</option>").attr("value",e[d].content_id);e[d].content_id===a&&r.attr("selected","selected").addClass("selected"),e[d].content_id===s&&r.addClass("hilite"),e[d].content_id!==this.options.value||this.options.allow_current||r.attr("disabled","disabled"),e[d].has_children||!this.options.use_perms||e[d].can_edit||r.attr("disabled","disabled").addClass("nochildren"),!this.options.for_child||e[d].has_children||e[d].wants_children||r.attr("disabled","disabled").addClass("nochildren"),o.append(r)}return o},_setup_smart_dropdowns:function(){var t=this;t.element.prevAll("select.cms_selhier").remove(),t.element.val("");var e=this.data.hidden_e.val(),a={m1_op:"here_up"};for(var i in a.m1_page=e,this.options)this.options.hasOwnProperty(i)&&(a["m1_"+i]=this.options[i]);return $.ajax(this.data.ajax_url,{dataType:"json",data:a}).fail(function(t,e,a){console.debug("smart dropdown population failed: "+a)}).done(function(a){if("success"===a.status){var i,s=!1,n=!0,o=a.data;t.options.for_child&&t.options.use_perms&&!t.options.is_manager&&(n=!1);for(var r=0;r<o.length&&!i;r++)for(var d=0;d<o[r].length&&!i;d++)if(o[r][d].content_id===e){i=o[r][d].id_hierarchy;break}if(i)try{s=i.split(".")}catch(t){s=[i]}for(var l=0;l<o.length&&null!==o[l];l++){var _=l<s.length?s[l]:-1,h=t.data.orig_pages&&l<t.data.orig_pages.length?t.data.orig_pages[l]:-100,c=t._build_smart_select(t.data.id+"_"+l,o[l],_,n,h);if(_)for(d=0;d<o[l].length;d++)if(o[l][d].content_id===_){n=o[l][d].wants_children,t.options.for_child||o[l][d].has_usable_link||(n=!1),t.options.for_child&&t.options.use_perms&&!t.options.is_manager&&!o[l][d].can_edit&&(n=!1);break}c.insertBefore(t.element)}}})},_setup_simple_dropdown:function(){var t=this,e=this.data.hidden_e.val(),a={m1_op:"userpages"};for(var i in this.options)this.options.hasOwnProperty(i)&&(a["m1_"+i]=this.options[i]);return $.ajax(this.data.ajax_url,{dataType:"json",data:a}).fail(function(t,e,a){console.debug("simple dropdown population failed: "+a)}).done(function(a){if("success"===a.status){var i=a.data;t._build_simple_select(t.data.id+"_0",i,e,!0,-1).insertBefore(t.element)}})},_noop:function(){}})}(jQuery);
