function CMSFileBrowser(e){var n,t,i,r=$("#fp-progress"),a=null,o=$("#fp-progress-text"),l=$("#fp-dropzone"),s=$("#fp-file-upload"),c=$("#fp-list");function d(){c.hasClass("list-view")||c.removeClass("grid-view").addClass("list-view")}function f(e){if(i.length>0){var n=cms_lang.error_title+":\n&nbsp;"+i.join("\n&nbsp;");cms_alert(n,!1,!0).then(function(){u(e)})}else setTimeout(function(){u(e)},2e3)}function u(e){cms_busy(!1),e?window.location.reload(!0):(r.hide().remove("fp-progress-inner"),a=null,o.hide().text(""),l.length>0&&l.removeClass("visuallyhidden"),s.blur())}function p(){t.cd_url&&$("#level-up").on("click",function(e){e.preventDefault(),window.location.href=t.cd_url});var e=$(".filepicker-cmd");e.length>0&&e.on("click",function(e){switch($(this).attr("data-cmd")){case"del":!function(e){e.preventDefault();var n=e.target.closest(".fpitem"),i=$(n).data("fb-fname");cms_confirm(t.lang.confirm_delete,!0).done(function(){var e=g("del",i);$.ajax(e).done(function(){window.location.reload(!0)}).fail(function(e,n,i){console.debug("FileBrowser deletion failed: "+i),cms_alert(t.lang.error_failed_ajax+": "+i)})})}(e);break;case"mkdir":!function(e){e.preventDefault(),cms_dialog($("#mkdir_dlg"),{modal:!0,buttons:[{text:t.lang.ok,click:function(){var e=$("#fld_mkdir").val().trim(),n=g("mkdir",e);$.ajax(n).done(function(){window.location.reload(!0)}).fail(function(e,n,i){console.debug("FileBrowser mkdir failed: "+i),cms_alert(t.lang.error_failed_ajax+": "+i)}),$(this).dialog("close")}},{text:t.lang.cancel,click:function(){$(this).dialog("close")}}]})}(e)}}),e=null}function g(e,n){return{method:"POST",url:t.cmd_url,data:{cmd:e,val:n,cwd:t.cwd,inst:t.inst}}}function m(e,n){return cms_lang[e]?cms_lang[e].replace("%s",n):n+" error"}t=top.document.CMSFileBrowser?$.extend({},top.document.CMSFileBrowser,e||{}):e||{},cms_lang=$.extend({},cms_lang||{},t.lang),function(){if(!($("#fp-type-filter").length<1)){var e=c.find(".fpitem").not(".header,.dir");$("#fp-type-filter .js-trigger").on("click",function(n){var t=$(this),i=t.attr("data-fb-type");"RESET"===i||t.hasClass("active")?e.show(150):e.hide(50).filter("div."+i).show(100),$("#fp-type-filter .js-trigger").removeClass("active"),t.addClass("active")})}}(),t.type&&"ALL"!==t.type?$('#fp-type-filter [data-fb-type="'+t.type+'"]').trigger("click"):$('#fp-type-filter [data-fb-type="RESET"]').addClass("active"),d();var v=0;$(window).on("resize",function(){var e=!0;0===v&&(v=setInterval(function(){e?e=!1:(clearInterval(v),v=0),window.innerWidth<380?(c.hasClass("grid-view")||c.removeClass("list-view").addClass("grid-view"),l.css("width","3em")):(d(),l.css("width","9em"))},250))}).on("close",function(){0!=v&&clearInterval(v)}),$(window).trigger("resize"),setTimeout(function(){$("a.js-trigger-insert").on("click",function(e){e.preventDefault();var n=$(this).attr("href"),i=t.inst||$("html").data("cmsfp-inst");if(t&&t.onselect)return t.onselect(i,n),!1;var r='[data-cmsfp-instance="'+i+'"]',a=parent.$(r);return a&&a.length&&(a.is(":input")&&(a.val(n),a.trigger("change")),a.trigger("cmsfp:change",n)),!1}),p(),function(){if(l.length>0){n=l;var e=!1;l.on("dragenter, dragover",function(n){$(this).addClass("dragging"),e=!0}).on("dragleave",function(n){$(this).removeClass("dragging"),e=!1}).on("mouseup",function(n){$(this).removeClass("dragging"),e&&(e=!1)})}else n=s;var c=s.attr("name");n.dmUploader({url:t.cmd_url,dataType:"json",extraData:{cmd:"upload",val:"",cwd:t.cwd,inst:t.inst,filefield:c},fieldName:c,inputFile:s[0],allowedTypes:t.mime||"*",extFilter:t.extensions||null,onBegin:function(){cms_busy(),i=[],l.length>0&&l.addClass("visuallyhidden"),o.show(),a=$("<div/>",{id:"fp-progress-inner"}),r.prepend(a).show()},onComplete:function(){f(!0)},onBeforeUpload:function(e){o.text(""),a.width(0)},onUploadProgress:function(e,n){a.animate({width:n+"%"},200,function(){$(this).attr("aria-valuenow",n),o.text(n+"%")})},onUploadCanceled:function(e){f(!0)},onUploadError:function(e,n,t,r){n.responseJSON?i.push(n.responseJSON.message):i.push(r.message)},onFileTypeError:function(e){i.push(m("error_type",e.data.name||"File"))},onFileExtError:function(e){i.push(m("error_ext",e.data.name||"File"))},onFileSizeError:function(e){i.push(m("error_size",e.data.name||"File"))}})}()},250)}