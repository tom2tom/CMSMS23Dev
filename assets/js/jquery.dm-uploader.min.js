/*!
jQuery Ajax File Uploader Widget V.1.1 <https://github.com/danielm/uploader>
(C) 2013-2020 Daniel Morales <daniel85mg@gmail.com>
License MIT
*/
!function(t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):"undefined"!=typeof exports?module.exports=t(require("jquery")):t(window.jQuery)}(function($){"use strict";var t=0,e=1,i=2,n=3,s=4,o=function(e,i){this.data=e,this.widget=i,this.jqXHR=null,this.status=t;var n=Math.random();this.id=(n+10*n).toString(36)};o.prototype.upload=function(){var t=this;if(!t.canUpload())return t.widget.queueRunning&&t.status!==e&&t.widget.processQueue(),!1;var i=new FormData;i.append(t.widget.settings.fieldName,t.data);var n=t.widget.settings.extraData;return"function"==typeof n&&(n=n.call(t.widget.element[0],t.id)),$.each(n,function(t,e){i.append(t,e)}),t.status=e,t.widget.activeFiles++,"function"==typeof t.widget.settings.onBeforeUpload&&t.widget.settings.onBeforeUpload.call(t.widget.element[0],t.id),t.widget.element.trigger("before.dmul",t.id),t.jqXHR=$.ajax({url:t.widget.settings.url,type:t.widget.settings.method,dataType:t.widget.settings.dataType,data:i,headers:t.widget.settings.headers,cache:!1,timeout:0,contentType:!1,processData:!1,forceSync:!1,xhr:function(){return t.getXhr()}}).done(function(e,i,n){t.onSuccess(e)}).fail(function(e,i,n){t.onError(e,i,n)}).always(function(e,i,n){t.onComplete()}),!0},o.prototype.onSuccess=function(t){this.status=i,"function"==typeof this.widget.settings.onUploadSuccess&&this.widget.settings.onUploadSuccess.call(this.widget.element[0],this.id,t),this.widget.element.trigger("success.dmul",[this.id,t])},o.prototype.onError=function(t,e,i){this.status!==s&&(this.status=n,"function"==typeof this.widget.settings.onUploadError&&this.widget.settings.onUploadError.call(this.widget.element[0],this.id,t,e,i),this.widget.element.trigger("error.dmul",[this.id,t,e,i]))},o.prototype.onComplete=function(){this.widget.activeFiles--,this.status!==s&&("function"==typeof this.widget.settings.onUploadComplete&&this.widget.settings.onUploadComplete.call(this.widget.element[0],this.id),this.widget.element.trigger("complete.dmul",this.id)),this.widget.queueRunning?this.widget.processQueue():this.widget.settings.queue&&0===this.widget.activeFiles&&("function"==typeof this.widget.settings.onComplete&&this.widget.settings.onComplete.call(this.widget.element[0]),this.widget.element.trigger("complete.dmul"))},o.prototype.getXhr=function(){var t=this,e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){var i=0,n=e.loaded||e.position,s=e.total||e.totalSize;e.lengthComputable&&(i=Math.ceil(n/s*100)),"function"==typeof t.widget.settings.onUploadProgress&&t.widget.settings.onUploadProgress.call(t.widget.element[0],t.id,i),t.widget.element.trigger("progress.dmul",[t.id,i])},!1),e},o.prototype.cancel=function(i){i=void 0!==i&&i;var n=this.status;return!!(n===e||i&&n===t)&&(this.status=s,"function"==typeof this.widget.settings.onUploadCanceled&&this.widget.settings.onUploadCanceled.call(this.widget.element[0],this.id),this.widget.element.trigger("cancel.dmul",this.id),n===e&&this.jqXHR.abort(),!0)},o.prototype.canUpload=function(){return this.status===t||this.status===n};var r=function(t,e){return this.element=t instanceof $?t:$(t),this.settings=$.extend({},$.fn.dmUploader.defaults,e||{}),this.checkSupport()?(this.init(),this):($.error("Browser not supported by the dmUploader plugin"),"function"==typeof this.settings.onFallbackMode&&this.settings.onFallbackMode.call(this.element[0]),this.element.trigger("fallback.dmul"),!1)};r.prototype.checkSupport=function(){if(void 0===window.FormData)return!1;var t=navigator.userAgent;return!t.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/)&&!t.match(/\swv\).+(chrome)\/([\w\.]+)/i)&&!$('<input type="file" />').prop("disabled")},r.prototype.getInput=function(){var t=null;return this.settings.inputFile&&((t=this.settings.inputFile)instanceof $||(t=$(t)),t.is("input[type=file]")||(t=null)),null===t&&(t=this.element.is("input[type=file]")?this.element:this.element.find("input[type=file]")),t},r.prototype.init=function(){this.queue=[],this.queuePos=-1,this.queueRunning=!1,this.activeFiles=0,this.draggingOver=0,this.draggingOverDoc=0;var t=this.getInput();if(t){if(t.prop("multiple",this.settings.multiple),"*"!==this.settings.allowedTypes||this.settings.extFilter){var e="*"!==this.settings.allowedTypes?this.settings.allowedTypes:"";this.settings.extFilter&&(this.settings.extFilter.forEach(function(t){"."===t[0]?e+=","+t:e+=",."+t}),","===e[0]&&(e=e.substring(1))),t.prop("accept",e)}else t.prop("accept","");var i=this;t.on("change",function(t){var e=t.target&&t.target.files;e&&e.length&&(i.addFiles(e),$(this).val(""))})}if(this.settings.dnd){var n=$("<div/>")[0];"draggable"in n||"ondragstart"in n&&"ondrop"in n?this.initDnD():this.settings.dnd=!1}return this.settings.paste&&this.initPaste(),t||this.settings.dnd||this.settings.paste?("function"==typeof this.settings.onInit&&this.settings.onInit.call(this.element[0]),this.element.trigger("init.dmul"),this):($.error("Markup error found by the dmUploader plugin"),null)},r.prototype.initDnD=function(){var t=this;function e(t){t.preventDefault(),t.stopPropagation()}this.element[0].addEventListener("drop",function(i){e(i),t.draggingOver>0&&(t.draggingOver=0,"function"==typeof t.settings.onDragLeave&&t.settings.onDragLeave.call(t.element[0]),t.element.trigger("dragleave"));var n,s=i.dataTransfer;s&&s.files&&0!=s.files.length&&(n=t.settings.multiple?s.files:[s.files[0]],t.addFiles(n))},!1),this.element[0].addEventListener("dragenter",function(i){e(i),0===t.draggingOver&&"function"==typeof t.settings.onDragEnter&&t.settings.onDragEnter.call(t.element[0]),t.draggingOver++},!1),this.element[0].addEventListener("dragleave",function(i){e(i),t.draggingOver--,0===t.draggingOver&&"function"==typeof t.settings.onDragLeave&&t.settings.onDragLeave.call(t.element[0])},!1),this.element[0].addEventListener("dragover",e,!1),this.settings.hookDocument&&this.element[0]!=document&&$(document).off("dragenter").on("dragenter.dmul",function(i){e(i),0===t.draggingOverDoc&&("function"==typeof t.settings.onDocumentDragEnter&&t.settings.onDocumentDragEnter.call(t.element[0]),t.element.trigger("docdragenter.dmul")),t.draggingOverDoc++}).off("dragleave").on("dragleave.dmul",function(i){e(i),t.draggingOverDoc--,0===t.draggingOverDoc&&("function"==typeof t.settings.onDocumentDragLeave&&t.settings.onDocumentDragLeave.call(t.element[0]),t.element.trigger("docdragleave.dmul"))}).off("dragover").on("dragover.dmul",function(t){t.preventDefault()}).off("drop").on("drop.dmul",function(i){e(i),t.draggingOverDoc>0&&(t.draggingOverDoc=0,"function"==typeof t.settings.onDocumentDragLeave&&t.settings.onDocumentDragLeave.call(t.element[0]),t.element.trigger("dragleave.dmul"))})},r.prototype.initPaste=function(){var t=this;document.addEventListener("paste",function(e){e.preventDefault();var i,n=e.clipboardData;n&&n.files&&0!=n.files.length&&(i=t.settings.multiple?n.files:[n.files[0]],t.addFiles(i))},!1)},r.prototype.releaseEvents=function(){this.element.off(".dmul");var t=this.getInput();t&&t.off(".dmul"),this.settings.hookDocument&&$(document).off(".dmul")},r.prototype.validateFile=function(t){if(this.settings.maxFileSize>0&&t.size>this.settings.maxFileSize)return"function"==typeof this.settings.onFileSizeError&&this.settings.onFileSizeError.call(this.element[0],t),this.element.trigger("sizeerror.dmul",[t]),!1;if("*"!==this.settings.allowedTypes&&!this.settings.allowedTypes.split(",").some(function(e){return t.type.match(e)}))return"function"==typeof this.settings.onFileTypeError&&this.settings.onFileTypeError.call(this.element[0],t),this.element.trigger("typeerror.dmul",[t]),!1;if(this.settings.extFilter){var e="\\."+this.settings.extFilter.join(".").replace(/\./g,"\\."),i="\\."+t.name.split(".").pop();if(!new RegExp(i,"i").test(e))return"function"==typeof this.settings.onFileExtError&&this.settings.onFileExtError.call(this.element[0],t),this.element.trigger("exterror.dmul",[t]),!1}return new o(t,this)},r.prototype.addFiles=function(t){var e,i,n=0;for(e=0,i=t.length;e<i;e++){var s=this.validateFile(t[e]);if(s){if("function"==typeof this.settings.onNewFile)if(!1===this.settings.onNewFile.call(this.element[0],s.id,s.data))continue;this.settings.auto&&!this.settings.queue&&(0===n&&("function"==typeof this.settings.onBegin&&this.settings.onBegin.call(this.element[0]),this.element.trigger("begin.dmul")),s.upload()),this.queue.push(s),n++}}return 0===n?this:(this.settings.auto&&this.settings.queue&&!this.queueRunning&&("function"==typeof this.settings.onBegin&&this.settings.onBegin.call(this.element[0]),this.element.trigger("begin.dmul"),this.processQueue()),this)},r.prototype.processQueue=function(){return this.queuePos++,this.queuePos>=this.queue.length?(0===this.activeFiles&&("function"==typeof this.settings.onComplete&&this.settings.onComplete.call(this.element[0]),this.element.trigger("complete.dmul")),this.queuePos=this.queue.length-1,this.queueRunning=!1,!1):(this.queueRunning=!0,this.queue[this.queuePos].upload())},r.prototype.restartQueue=function(){this.queuePos=-1,this.queueRunning=!1,this.processQueue()},r.prototype.findById=function(t){var e,i;for(e=0,i=this.queue.length;e<i;e++)if(this.queue[e].id===t)return this.queue[e];return!1},r.prototype.cancelAll=function(){var t,e,i=this.queueRunning;for(this.queueRunning=!1,t=0,e=this.queue.length;t<e;t++)this.queue[t].cancel();i&&("function"==typeof this.settings.onComplete&&this.settings.onComplete.call(this.element[0]),this.element.trigger("complete.dmul"))},r.prototype.startAll=function(){var t,e;if(this.settings.queue)this.restartQueue();else for(t=0,e=this.queue.length;t<e;t++)this.queue[t].upload()},r.prototype.methods={start:function(e){if(this.queueRunning)return!1;var i=!1;return void 0===e||(i=this.findById(e))?i?(i.status===s&&(i.status=t),i.upload()):(this.startAll(),!0):($.error("File not found in the dmUploader plugin"),!1)},cancel:function(t){var e=!1;return void 0===t||(e=this.findById(t))?e?e.cancel(!0):(this.cancelAll(),!0):($.error("File not found in the dmUploader plugin"),!1)},reset:function(){return this.cancelAll(),this.queue=[],this.queuePos=-1,this.activeFiles=0,!0},destroy:function(){this.cancelAll(),this.releaseEvents(),this.element.removeData("dmUploader")}},$.fn.dmUploader=function(t){if("string"!=typeof t)return this.each(function(){$.data(this,"dmUploader")||$.data(this,"dmUploader",new r(this,t))});var e=arguments;this.each(function(){var i=$.data(this,"dmUploader");i instanceof r?"function"==typeof i.methods[t]?i.methods[t].apply(i,Array.prototype.slice.call(e,1)):$.error("Method "+t+" does not exist in the dmUploader plugin"):$.error("Unknown plugin data found by the dmUploader plugin")})},$.fn.dmUploader.defaults=$.extend({},{auto:!0,queue:!0,dnd:!0,paste:!0,hookDocument:!0,multiple:!0,url:document.URL,method:"POST",extraData:{},headers:{},dataType:null,fieldName:"file",maxFileSize:0,allowedTypes:"*",extFilter:null,inputFile:null,onNewFile:null},$.fn.dmUploader.defaults||{})});
